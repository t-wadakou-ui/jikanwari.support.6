<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>高校教員用 週案管理アプリ</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* Base Styles & Resets */
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden; 
            position: fixed; 
        }

        body {
            font-family: 'BIZ UDPGothic', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f3f4f6;
            touch-action: manipulation; 
            overscroll-behavior-y: contain;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }

        .modal-overlay { z-index: 50; }
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 200ms ease-out; }
        .modal-exit { opacity: 1; transform: scale(1); }
        .modal-exit-active { opacity: 0; transform: scale(0.95); transition: all 200ms ease-in; }

        .timetable-grid {
            display: grid;
            grid-template-columns: 35px repeat(6, minmax(0, 1fr));
            gap: 2px;
            background-color: #e5e7eb;
            border: 1px solid #e5e7eb;
        }
        .timetable-cell {
            background-color: white;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 0.85rem;
            cursor: pointer;
            padding: 2px;
            transition: background-color 0.1s;
        }
        .timetable-cell:active {
            background-color: #f9fafb;
        }
        .daily-memo-cell {
            background-color: #fffbeb;
            min-height: 50px; 
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            text-align: center;
            font-size: 0.75rem;
            cursor: pointer;
            padding: 4px 2px;
            transition: background-color 0.1s;
            color: #92400e;
            font-weight: bold;
            line-height: 1.2;
        }
        .timetable-header {
            background-color: #f9fafb;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .period-header {
            background-color: #f9fafb;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 1rem; 
            word-break: break-all;
            padding: 2px;
            line-height: 1.1;
        }

        /* スワイプ可能なエリアのスタイル */
        .swipeable-timetable {
            touch-action: pan-y pinch-zoom;
            user-select: none;
        }

        @media print {
            @page {
                size: landscape;
                margin: 5mm; 
            }
            html, body {
                height: auto !important;
                overflow: visible !important;
                position: static !important;
                background-color: white !important;
                zoom: 0.95;
            }
            #root, .main-container {
                height: auto !important;
                overflow: visible !important;
                max-width: none !important;
                box-shadow: none !important;
            }
            nav, .no-print, button:not(.hidden), .settings-btn {
                display: none !important;
            }
            main {
                padding-top: 0 !important;
                overflow: visible !important;
            }
            .pb-10, .pb-20 {
                padding-bottom: 0 !important;
            }

            .timetable-grid {
                border: 2px solid #000;
                gap: 0;
                width: 100% !important;
                min-width: 0 !important;
            }
            .timetable-header, .period-header, .timetable-cell, .daily-memo-cell {
                border: 1px solid #666;
            }
            .timetable-header {
                background-color: #f0f0f0 !important;
                color: #000 !important;
                padding: 2px 0 !important;
            }
            
            .timetable-cell {
                min-height: 77px !important; 
                height: auto !important;
                font-size: 10pt !important;
                padding: 1px !important;
            }
            .timetable-cell .text-xs { font-size: 8pt !important; }
            .timetable-cell .text-sm { font-size: 9pt !important; }
            
            .daily-memo-cell {
                min-height: 40px !important;
                font-size: 9pt !important;
                padding: 1px !important;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // ============================================================
        // Utility Functions
        // ============================================================
        
        const getMonday = (date) => {
            const d = new Date(date);
            const day = d.getDay();
            const diff = (day === 0 ? -6 : 1) - day;
            d.setDate(d.getDate() + diff);
            d.setHours(0, 0, 0, 0);
            return d;
        };

        const formatDateKey = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        const formatDateDisplay = (date) => {
            const m = date.getMonth() + 1;
            const d = date.getDate();
            return `${m}/${d}`;
        };

        const formatDateMMDD = (date) => {
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${m}/${d}`;
        };

        const addDays = (date, days) => {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        };

        const getDayName = (dayIndex) => {
            const names = ['月', '火', '水', '木', '金', '土'];
            return names[dayIndex];
        };

        const getCurrentAcademicYear = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            return month >= 4 ? year : year - 1;
        };

        // ============================================================
        // Components
        // ============================================================

        const Icon = ({ name, className = '' }) => (
            <i className={`ph ph-${name} ${className}`}></i>
        );

        const Modal = ({ isOpen, onClose, children, title }) => {
            useEffect(() => {
                if (isOpen) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                }
                return () => { document.body.style.overflow = ''; };
            }, [isOpen]);

            if (!isOpen) return null;

            return (
                <div className="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[85vh] overflow-y-auto modal-enter-active" onClick={(e) => e.stopPropagation()}>
                        <div className="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center z-10">
                            <h3 className="text-lg font-bold">{title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                        </div>
                        <div className="p-6">{children}</div>
                    </div>
                </div>
            );
        };

        // ============================================================
        // Main App Component
        // ============================================================

        const App = () => {
            const [currentYear, setCurrentYear] = useState(getCurrentAcademicYear());
            const [courses, setCourses] = useState([]);
            const [basicSchedules, setBasicSchedules] = useState({});
            const [weeklySchedules, setWeeklySchedules] = useState({});
            const [weeklyMemos, setWeeklyMemos] = useState({});
            const [currentView, setCurrentView] = useState('timetable');
            const [currentMonday, setCurrentMonday] = useState(getMonday(new Date()));
            const [statsRange, setStatsRange] = useState({
                start: formatDateKey(getMonday(new Date())),
                end: formatDateKey(addDays(getMonday(new Date()), 5))
            });
            const [termSettings, setTermSettings] = useState([
                { id: 1, name: '1学期', start: '', end: '' },
                { id: 2, name: '2学期', start: '', end: '' },
                { id: 3, name: '3学期', start: '', end: '' }
            ]);
            const [periodLabels, setPeriodLabels] = useState(['1', '2', '3', '4', '5', '6', '7']);

            // Load data from localStorage
            useEffect(() => {
                const loadData = () => {
                    try {
                        const savedCourses = localStorage.getItem(`courses_${currentYear}`);
                        const savedBasic = localStorage.getItem(`basicSchedules_${currentYear}`);
                        const savedWeekly = localStorage.getItem(`weeklySchedules_${currentYear}`);
                        const savedMemos = localStorage.getItem(`weeklyMemos_${currentYear}`);
                        const savedTerms = localStorage.getItem(`termSettings_${currentYear}`);
                        const savedPeriods = localStorage.getItem(`periodLabels_${currentYear}`);

                        if (savedCourses) setCourses(JSON.parse(savedCourses));
                        if (savedBasic) setBasicSchedules(JSON.parse(savedBasic));
                        if (savedWeekly) setWeeklySchedules(JSON.parse(savedWeekly));
                        if (savedMemos) setWeeklyMemos(JSON.parse(savedMemos));
                        if (savedTerms) setTermSettings(JSON.parse(savedTerms));
                        if (savedPeriods) setPeriodLabels(JSON.parse(savedPeriods));
                    } catch (error) {
                        console.error('データ読み込みエラー:', error);
                        alert('データの読み込み中にエラーが発生しました');
                    }
                };
                loadData();
            }, [currentYear]);

            // Save data to localStorage
            useEffect(() => {
                try {
                    localStorage.setItem(`courses_${currentYear}`, JSON.stringify(courses));
                } catch (error) {
                    console.error('保存エラー:', error);
                }
            }, [courses, currentYear]);

            useEffect(() => {
                try {
                    localStorage.setItem(`basicSchedules_${currentYear}`, JSON.stringify(basicSchedules));
                } catch (error) {
                    console.error('保存エラー:', error);
                }
            }, [basicSchedules, currentYear]);

            useEffect(() => {
                try {
                    localStorage.setItem(`weeklySchedules_${currentYear}`, JSON.stringify(weeklySchedules));
                } catch (error) {
                    console.error('保存エラー:', error);
                }
            }, [weeklySchedules, currentYear]);

            useEffect(() => {
                try {
                    localStorage.setItem(`weeklyMemos_${currentYear}`, JSON.stringify(weeklyMemos));
                } catch (error) {
                    console.error('保存エラー:', error);
                }
            }, [weeklyMemos, currentYear]);

            useEffect(() => {
                try {
                    localStorage.setItem(`termSettings_${currentYear}`, JSON.stringify(termSettings));
                } catch (error) {
                    console.error('保存エラー:', error);
                }
            }, [termSettings, currentYear]);

            useEffect(() => {
                try {
                    localStorage.setItem(`periodLabels_${currentYear}`, JSON.stringify(periodLabels));
                } catch (error) {
                    console.error('保存エラー:', error);
                }
            }, [periodLabels, currentYear]);

            const changeWeek = (direction) => {
                setCurrentMonday(prev => addDays(prev, direction * 7));
            };

            const goToToday = () => {
                setCurrentMonday(getMonday(new Date()));
            };

            return (
                <div className="h-full flex flex-col bg-gray-50">
                    <nav className="bg-white shadow-sm border-b flex-shrink-0 no-print">
                        <div className="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
                            <h1 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                                <Icon name="calendar-check" className="text-xl" />
                                週案管理 ({currentYear}年度)
                            </h1>
                            <YearSelector currentYear={currentYear} setCurrentYear={setCurrentYear} />
                        </div>
                        <div className="bg-gray-50 border-t">
                            <div className="max-w-4xl mx-auto px-2 py-2 flex gap-1 overflow-x-auto">
                                {[
                                    { key: 'timetable', label: '時間割', icon: 'table' },
                                    { key: 'basic', label: '基本時間割', icon: 'calendar-blank' },
                                    { key: 'courses', label: '講座管理', icon: 'book-open' },
                                    { key: 'stats', label: '時数集計', icon: 'chart-pie-slice' }
                                ].map(view => (
                                    <button
                                        key={view.key}
                                        onClick={() => setCurrentView(view.key)}
                                        className={`flex-1 py-2 px-3 rounded-lg text-xs font-bold transition-colors flex items-center justify-center gap-1 whitespace-nowrap ${
                                            currentView === view.key
                                                ? 'bg-indigo-600 text-white shadow'
                                                : 'bg-white text-gray-600 hover:bg-gray-100'
                                        }`}
                                    >
                                        <Icon name={view.icon} />
                                        <span>{view.label}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </nav>

                    <main className="flex-1 overflow-hidden">
                        <div className="h-full max-w-4xl mx-auto">
                            {currentView === 'timetable' && (
                                <TimetableView
                                    courses={courses}
                                    basicSchedules={basicSchedules}
                                    weeklySchedules={weeklySchedules}
                                    setWeeklySchedules={setWeeklySchedules}
                                    weeklyMemos={weeklyMemos}
                                    setWeeklyMemos={setWeeklyMemos}
                                    currentMonday={currentMonday}
                                    changeWeek={changeWeek}
                                    goToToday={goToToday}
                                    periodLabels={periodLabels}
                                />
                            )}
                            {currentView === 'basic' && (
                                <BasicScheduleView
                                    courses={courses}
                                    basicSchedules={basicSchedules}
                                    setBasicSchedules={setBasicSchedules}
                                    periodLabels={periodLabels}
                                    setPeriodLabels={setPeriodLabels}
                                />
                            )}
                            {currentView === 'courses' && (
                                <CoursesView courses={courses} setCourses={setCourses} />
                            )}
                            {currentView === 'stats' && (
                                <StatsView
                                    weeklySchedules={weeklySchedules}
                                    courses={courses}
                                    basicSchedules={basicSchedules}
                                    weeklyMemos={weeklyMemos}
                                    statsRange={statsRange}
                                    setStatsRange={setStatsRange}
                                    termSettings={termSettings}
                                    setTermSettings={setTermSettings}
                                    periodLabels={periodLabels}
                                    currentYear={currentYear}
                                />
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        // ============================================================
        // Year Selector Component
        // ============================================================

        const YearSelector = ({ currentYear, setCurrentYear }) => {
            const [isOpen, setIsOpen] = useState(false);
            const years = Array.from({ length: 10 }, (_, i) => currentYear - 5 + i);

            return (
                <div className="relative">
                    <button
                        onClick={() => setIsOpen(!isOpen)}
                        className="flex items-center gap-2 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-bold transition-colors"
                    >
                        {currentYear}年度
                        <Icon name="caret-down" className={`transition-transform ${isOpen ? 'rotate-180' : ''}`} />
                    </button>
                    {isOpen && (
                        <>
                            <div className="fixed inset-0 z-10" onClick={() => setIsOpen(false)}></div>
                            <div className="absolute right-0 mt-2 bg-white border rounded-lg shadow-lg py-2 z-20 min-w-[120px]">
                                {years.map(year => (
                                    <button
                                        key={year}
                                        onClick={() => {
                                            setCurrentYear(year);
                                            setIsOpen(false);
                                        }}
                                        className={`block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 ${
                                            year === currentYear ? 'bg-indigo-50 text-indigo-600 font-bold' : ''
                                        }`}
                                    >
                                        {year}年度
                                    </button>
                                ))}
                            </div>
                        </>
                    )}
                </div>
            );
        };

        // ============================================================
        // Timetable View Component
        // ============================================================

        const TimetableView = ({
            courses,
            basicSchedules,
            weeklySchedules,
            setWeeklySchedules,
            weeklyMemos,
            setWeeklyMemos,
            currentMonday,
            changeWeek,
            goToToday,
            periodLabels
        }) => {
            const [selectedCell, setSelectedCell] = useState(null);
            const [selectedDayMemo, setSelectedDayMemo] = useState(null);
            const mondayKey = formatDateKey(currentMonday);
            const weekData = weeklySchedules[mondayKey] || {};
            const memoData = weeklyMemos[mondayKey] || {};

            // スワイプ検出用のstate
            const timetableRef = useRef(null);
            const [touchStart, setTouchStart] = useState(null);
            const [touchEnd, setTouchEnd] = useState(null);

            // 最小スワイプ距離（ピクセル）
            const minSwipeDistance = 50;

            const handleTouchStart = (e) => {
                setTouchEnd(null);
                setTouchStart(e.targetTouches[0].clientX);
            };

            const handleTouchMove = (e) => {
                setTouchEnd(e.targetTouches[0].clientX);
            };

            const handleTouchEnd = () => {
                if (!touchStart || !touchEnd) return;
                
                const distance = touchStart - touchEnd;
                const isLeftSwipe = distance > minSwipeDistance;
                const isRightSwipe = distance < -minSwipeDistance;

                if (isLeftSwipe) {
                    changeWeek(1); // 次週
                } else if (isRightSwipe) {
                    changeWeek(-1); // 前週
                }
            };

            const handleCellClick = (dayIndex, period) => {
                setSelectedCell({ dayIndex, period });
            };

            const handleDayMemoClick = (dayIndex) => {
                setSelectedDayMemo(dayIndex);
            };

            const setCellCourse = (courseId) => {
                if (!selectedCell) return;
                const { dayIndex, period } = selectedCell;
                const cellKey = `${dayIndex}-${period}`;
                setWeeklySchedules(prev => ({
                    ...prev,
                    [mondayKey]: {
                        ...prev[mondayKey],
                        [cellKey]: courseId || null
                    }
                }));
                setSelectedCell(null);
            };

            const setDayMemo = (text) => {
                if (selectedDayMemo === null) return;
                setWeeklyMemos(prev => ({
                    ...prev,
                    [mondayKey]: {
                        ...prev[mondayKey],
                        [selectedDayMemo]: text
                    }
                }));
                setSelectedDayMemo(null);
            };

            const copyFromBasic = () => {
                if (!window.confirm('基本時間割から今週の時間割にコピーしますか?')) return;
                const newWeekData = {};
                [0, 1, 2, 3, 4, 5].forEach(dayIndex => {
                    [1, 2, 3, 4, 5, 6, 7].forEach(period => {
                        const basicKey = `${dayIndex}-${period}`;
                        if (basicSchedules[basicKey]) {
                            newWeekData[basicKey] = basicSchedules[basicKey];
                        }
                    });
                });
                setWeeklySchedules(prev => ({
                    ...prev,
                    [mondayKey]: newWeekData
                }));
                alert('基本時間割からコピーしました');
            };

            const copyFromPreviousWeek = () => {
                const prevMonday = addDays(currentMonday, -7);
                const prevKey = formatDateKey(prevMonday);
                const prevData = weeklySchedules[prevKey];
                
                if (!prevData || Object.keys(prevData).length === 0) {
                    alert('前週のデータがありません');
                    return;
                }
                
                if (!window.confirm('前週の時間割を今週にコピーしますか?')) return;
                
                setWeeklySchedules(prev => ({
                    ...prev,
                    [mondayKey]: { ...prevData }
                }));
                alert('前週からコピーしました');
            };

            const clearWeek = () => {
                if (!window.confirm('今週の時間割をすべてクリアしますか?')) return;
                setWeeklySchedules(prev => ({
                    ...prev,
                    [mondayKey]: {}
                }));
                alert('今週の時間割をクリアしました');
            };

            const handlePrint = () => {
                window.print();
            };

            return (
                <div className="h-full flex flex-col bg-white">
                    <div className="flex-shrink-0 border-b bg-gray-50 p-3 no-print">
                        <div className="flex items-center justify-between mb-3">
                            <button onClick={() => changeWeek(-1)} className="p-2 hover:bg-gray-200 rounded-lg transition-colors">
                                <Icon name="caret-left" className="text-xl" />
                            </button>
                            <div className="flex items-center gap-2">
                                <h2 className="text-base font-bold">
                                    {formatDateDisplay(currentMonday)} 〜 {formatDateDisplay(addDays(currentMonday, 5))}
                                </h2>
                                <button
                                    onClick={goToToday}
                                    className="px-3 py-1 bg-indigo-600 text-white text-xs rounded-lg font-bold hover:bg-indigo-700 transition-colors"
                                >
                                    今週
                                </button>
                            </div>
                            <button onClick={() => changeWeek(1)} className="p-2 hover:bg-gray-200 rounded-lg transition-colors">
                                <Icon name="caret-right" className="text-xl" />
                            </button>
                        </div>
                        <div className="flex gap-2">
                            <button
                                onClick={copyFromBasic}
                                className="flex-1 py-2 bg-white border border-gray-300 rounded-lg text-xs font-bold hover:bg-gray-50 transition-colors flex items-center justify-center gap-1"
                            >
                                <Icon name="copy" />
                                基本からコピー
                            </button>
                            <button
                                onClick={copyFromPreviousWeek}
                                className="flex-1 py-2 bg-white border border-gray-300 rounded-lg text-xs font-bold hover:bg-gray-50 transition-colors flex items-center justify-center gap-1"
                            >
                                <Icon name="arrow-counter-clockwise" />
                                前週コピー
                            </button>
                            <button
                                onClick={clearWeek}
                                className="flex-1 py-2 bg-white border border-red-300 text-red-600 rounded-lg text-xs font-bold hover:bg-red-50 transition-colors flex items-center justify-center gap-1"
                            >
                                <Icon name="trash" />
                                クリア
                            </button>
                        </div>
                        <button
                            onClick={handlePrint}
                            className="w-full mt-2 py-2 bg-gray-800 text-white rounded-lg text-xs font-bold hover:bg-gray-700 transition-colors flex items-center justify-center gap-1"
                        >
                            <Icon name="printer" />
                            印刷
                        </button>
                    </div>

                    <div 
                        ref={timetableRef}
                        className="flex-1 overflow-auto p-3 swipeable-timetable"
                        onTouchStart={handleTouchStart}
                        onTouchMove={handleTouchMove}
                        onTouchEnd={handleTouchEnd}
                    >
                        <div className="timetable-grid">
                            <div className="timetable-header"></div>
                            {[0, 1, 2, 3, 4, 5].map(dayIndex => {
                                const date = addDays(currentMonday, dayIndex);
                                return (
                                    <div key={dayIndex} className="timetable-header">
                                        <div className="flex flex-col items-center">
                                            <span className="text-sm font-bold">{getDayName(dayIndex)}</span>
                                            <span className="text-xs text-gray-500">{formatDateDisplay(date)}</span>
                                        </div>
                                    </div>
                                );
                            })}

                            {[1, 2, 3, 4, 5, 6, 7].map(period => (
                                <React.Fragment key={period}>
                                    <div className="period-header">
                                        {periodLabels[period - 1] || period}
                                    </div>
                                    {[0, 1, 2, 3, 4, 5].map(dayIndex => {
                                        const cellKey = `${dayIndex}-${period}`;
                                        const courseId = weekData[cellKey];
                                        const course = courses.find(c => c.id === courseId);
                                        return (
                                            <div
                                                key={cellKey}
                                                className="timetable-cell"
                                                style={{ backgroundColor: course ? course.color : 'white' }}
                                                onClick={() => handleCellClick(dayIndex, period)}
                                            >
                                                {course && (
                                                    <>
                                                        <div className="font-bold text-xs mb-0.5">{course.name}</div>
                                                        {course.room && <div className="text-[10px] text-gray-600">{course.room}</div>}
                                                    </>
                                                )}
                                            </div>
                                        );
                                    })}
                                </React.Fragment>
                            ))}

                            <div className="period-header">備考</div>
                            {[0, 1, 2, 3, 4, 5].map(dayIndex => (
                                <div
                                    key={`memo-${dayIndex}`}
                                    className="daily-memo-cell"
                                    onClick={() => handleDayMemoClick(dayIndex)}
                                >
                                    {memoData[dayIndex] && (
                                        <span className="whitespace-pre-wrap break-words w-full">
                                            {memoData[dayIndex]}
                                        </span>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>

                    <Modal
                        isOpen={selectedCell !== null}
                        onClose={() => setSelectedCell(null)}
                        title={selectedCell ? `${getDayName(selectedCell.dayIndex)} ${periodLabels[selectedCell.period - 1] || selectedCell.period}時限` : ''}
                    >
                        <div className="space-y-2">
                            <button
                                onClick={() => setCellCourse(null)}
                                className="w-full py-3 bg-gray-100 rounded-lg font-bold hover:bg-gray-200 transition-colors"
                            >
                                空きコマ
                            </button>
                            {courses.map(course => (
                                <button
                                    key={course.id}
                                    onClick={() => setCellCourse(course.id)}
                                    className="w-full py-3 rounded-lg font-bold transition-colors text-left px-4 flex items-center gap-3"
                                    style={{ backgroundColor: course.color }}
                                >
                                    <span>{course.name}</span>
                                    {course.room && <span className="text-xs opacity-75">({course.room})</span>}
                                </button>
                            ))}
                        </div>
                    </Modal>

                    <Modal
                        isOpen={selectedDayMemo !== null}
                        onClose={() => setSelectedDayMemo(null)}
                        title={selectedDayMemo !== null ? `${getDayName(selectedDayMemo)} 備考` : ''}
                    >
                        <textarea
                            className="w-full border rounded-lg p-3 text-sm resize-none"
                            rows="6"
                            placeholder="備考を入力..."
                            value={selectedDayMemo !== null ? (memoData[selectedDayMemo] || '') : ''}
                            onChange={(e) => {
                                if (selectedDayMemo !== null) {
                                    setWeeklyMemos(prev => ({
                                        ...prev,
                                        [mondayKey]: {
                                            ...prev[mondayKey],
                                            [selectedDayMemo]: e.target.value
                                        }
                                    }));
                                }
                            }}
                        />
                        <button
                            onClick={() => setDayMemo(selectedDayMemo !== null ? (memoData[selectedDayMemo] || '') : '')}
                            className="w-full mt-3 py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition-colors"
                        >
                            保存
                        </button>
                    </Modal>
                </div>
            );
        };

        // ============================================================
        // Basic Schedule View Component
        // ============================================================

        const BasicScheduleView = ({ courses, basicSchedules, setBasicSchedules, periodLabels, setPeriodLabels }) => {
            const [selectedCell, setSelectedCell] = useState(null);
            const [isEditingLabels, setIsEditingLabels] = useState(false);
            const [tempLabels, setTempLabels] = useState([...periodLabels]);

            const handleCellClick = (dayIndex, period) => {
                setSelectedCell({ dayIndex, period });
            };

            const setCellCourse = (courseId) => {
                if (!selectedCell) return;
                const { dayIndex, period } = selectedCell;
                const cellKey = `${dayIndex}-${period}`;
                setBasicSchedules(prev => ({
                    ...prev,
                    [cellKey]: courseId || null
                }));
                setSelectedCell(null);
            };

            const clearBasicSchedule = () => {
                if (!window.confirm('基本時間割をすべてクリアしますか?')) return;
                setBasicSchedules({});
                alert('基本時間割をクリアしました');
            };

            const handleSaveLabels = () => {
                setPeriodLabels([...tempLabels]);
                setIsEditingLabels(false);
                alert('時限名を保存しました');
            };

            const handleCancelEditLabels = () => {
                setTempLabels([...periodLabels]);
                setIsEditingLabels(false);
            };

            return (
                <div className="h-full flex flex-col bg-white">
                    <div className="flex-shrink-0 border-b bg-gray-50 p-3">
                        <div className="flex items-center justify-between mb-3">
                            <h2 className="text-base font-bold">基本時間割</h2>
                            <button
                                onClick={() => {
                                    setTempLabels([...periodLabels]);
                                    setIsEditingLabels(true);
                                }}
                                className="px-3 py-1.5 bg-white border border-gray-300 rounded-lg text-xs font-bold hover:bg-gray-50 transition-colors flex items-center gap-1"
                            >
                                <Icon name="pencil" />
                                時限名編集
                            </button>
                        </div>
                        <button
                            onClick={clearBasicSchedule}
                            className="w-full py-2 bg-white border border-red-300 text-red-600 rounded-lg text-xs font-bold hover:bg-red-50 transition-colors flex items-center justify-center gap-1"
                        >
                            <Icon name="trash" />
                            基本時間割をクリア
                        </button>
                    </div>

                    <div className="flex-1 overflow-auto p-3">
                        <div className="timetable-grid">
                            <div className="timetable-header"></div>
                            {[0, 1, 2, 3, 4].map(dayIndex => (
                                <div key={dayIndex} className="timetable-header">
                                    {getDayName(dayIndex)}
                                </div>
                            ))}

                            {[1, 2, 3, 4, 5, 6, 7].map(period => (
                                <React.Fragment key={period}>
                                    <div className="period-header">
                                        {periodLabels[period - 1] || period}
                                    </div>
                                    {[0, 1, 2, 3, 4].map(dayIndex => {
                                        const cellKey = `${dayIndex}-${period}`;
                                        const courseId = basicSchedules[cellKey];
                                        const course = courses.find(c => c.id === courseId);
                                        return (
                                            <div
                                                key={cellKey}
                                                className="timetable-cell"
                                                style={{ backgroundColor: course ? course.color : 'white' }}
                                                onClick={() => handleCellClick(dayIndex, period)}
                                            >
                                                {course && (
                                                    <>
                                                        <div className="font-bold text-xs mb-0.5">{course.name}</div>
                                                        {course.room && <div className="text-[10px] text-gray-600">{course.room}</div>}
                                                    </>
                                                )}
                                            </div>
                                        );
                                    })}
                                </React.Fragment>
                            ))}
                        </div>
                    </div>

                    <Modal
                        isOpen={selectedCell !== null}
                        onClose={() => setSelectedCell(null)}
                        title={selectedCell ? `${getDayName(selectedCell.dayIndex)} ${periodLabels[selectedCell.period - 1] || selectedCell.period}時限` : ''}
                    >
                        <div className="space-y-2">
                            <button
                                onClick={() => setCellCourse(null)}
                                className="w-full py-3 bg-gray-100 rounded-lg font-bold hover:bg-gray-200 transition-colors"
                            >
                                空きコマ
                            </button>
                            {courses.map(course => (
                                <button
                                    key={course.id}
                                    onClick={() => setCellCourse(course.id)}
                                    className="w-full py-3 rounded-lg font-bold transition-colors text-left px-4 flex items-center gap-3"
                                    style={{ backgroundColor: course.color }}
                                >
                                    <span>{course.name}</span>
                                    {course.room && <span className="text-xs opacity-75">({course.room})</span>}
                                </button>
                            ))}
                        </div>
                    </Modal>

                    <Modal
                        isOpen={isEditingLabels}
                        onClose={handleCancelEditLabels}
                        title="時限名の編集"
                    >
                        <div className="space-y-3">
                            <p className="text-xs text-gray-500">各時限の名称を編集できます(例: 1時限→1限、朝学習など)</p>
                            {tempLabels.map((label, index) => (
                                <div key={index} className="flex items-center gap-2">
                                    <span className="text-sm font-bold w-12">{index + 1}:</span>
                                    <input
                                        type="text"
                                        value={label}
                                        onChange={(e) => {
                                            const newLabels = [...tempLabels];
                                            newLabels[index] = e.target.value;
                                            setTempLabels(newLabels);
                                        }}
                                        className="flex-1 border rounded px-3 py-2 text-sm"
                                        placeholder={`${index + 1}時限`}
                                    />
                                </div>
                            ))}
                            <div className="flex gap-2 pt-4">
                                <button
                                    onClick={handleCancelEditLabels}
                                    className="flex-1 py-3 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300 transition-colors"
                                >
                                    キャンセル
                                </button>
                                <button
                                    onClick={handleSaveLabels}
                                    className="flex-1 py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition-colors"
                                >
                                    保存
                                </button>
                            </div>
                        </div>
                    </Modal>
                </div>
            );
        };

        // ============================================================
        // Courses View Component
        // ============================================================

        const CoursesView = ({ courses, setCourses }) => {
            const [editingCourse, setEditingCourse] = useState(null);
            const [isAdding, setIsAdding] = useState(false);
            const [newCourseName, setNewCourseName] = useState('');
            const [newCourseRoom, setNewCourseRoom] = useState('');
            const [newCourseColor, setNewCourseColor] = useState('#93c5fd');

            const colorPresets = [
                '#93c5fd', '#fbbf24', '#34d399', '#f87171', '#a78bfa',
                '#fb923c', '#60a5fa', '#fbbf24', '#4ade80', '#f472b6',
                '#c084fc', '#38bdf8', '#facc15', '#22d3ee', '#fb7185'
            ];

            const addCourse = () => {
                if (!newCourseName.trim()) {
                    alert('講座名を入力してください');
                    return;
                }
                const newCourse = {
                    id: Date.now().toString(),
                    name: newCourseName.trim(),
                    room: newCourseRoom.trim(),
                    color: newCourseColor
                };
                setCourses(prev => [...prev, newCourse]);
                setNewCourseName('');
                setNewCourseRoom('');
                setNewCourseColor('#93c5fd');
                setIsAdding(false);
                alert('講座を追加しました');
            };

            const updateCourse = (courseId, field, value) => {
                setCourses(prev => prev.map(c =>
                    c.id === courseId ? { ...c, [field]: value } : c
                ));
            };

            const deleteCourse = (courseId) => {
                if (!window.confirm('この講座を削除しますか?')) return;
                setCourses(prev => prev.filter(c => c.id !== courseId));
                setEditingCourse(null);
                alert('講座を削除しました');
            };

            return (
                <div className="h-full flex flex-col bg-white overflow-y-auto pb-20">
                    <div className="flex-shrink-0 border-b bg-gray-50 p-3">
                        <div className="flex items-center justify-between">
                            <h2 className="text-base font-bold">講座管理</h2>
                            <button
                                onClick={() => setIsAdding(true)}
                                className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold hover:bg-indigo-700 transition-colors flex items-center gap-1"
                            >
                                <Icon name="plus" />
                                講座を追加
                            </button>
                        </div>
                    </div>

                    <div className="p-4 space-y-3">
                        {courses.length === 0 && (
                            <div className="text-center py-12 text-gray-400">
                                <Icon name="book-open" className="text-4xl mb-2" />
                                <p className="text-sm">講座が登録されていません</p>
                            </div>
                        )}
                        {courses.map(course => (
                            <div
                                key={course.id}
                                className="bg-white border rounded-xl p-4 hover:shadow-md transition-shadow cursor-pointer"
                                onClick={() => setEditingCourse(course)}
                            >
                                <div className="flex items-center gap-3">
                                    <div
                                        className="w-4 h-4 rounded-full flex-shrink-0"
                                        style={{ backgroundColor: course.color }}
                                    ></div>
                                    <div className="flex-1">
                                        <div className="font-bold text-gray-800">{course.name}</div>
                                        {course.room && (
                                            <div className="text-xs text-gray-500 mt-0.5">{course.room}</div>
                                        )}
                                    </div>
                                    <Icon name="pencil" className="text-gray-400" />
                                </div>
                            </div>
                        ))}
                    </div>

                    <Modal
                        isOpen={isAdding}
                        onClose={() => {
                            setIsAdding(false);
                            setNewCourseName('');
                            setNewCourseRoom('');
                            setNewCourseColor('#93c5fd');
                        }}
                        title="新しい講座を追加"
                    >
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-bold mb-2">講座名 *</label>
                                <input
                                    type="text"
                                    value={newCourseName}
                                    onChange={(e) => setNewCourseName(e.target.value)}
                                    className="w-full border rounded-lg px-3 py-2 text-sm"
                                    placeholder="例: 数学I"
                                    autoFocus
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-bold mb-2">教室</label>
                                <input
                                    type="text"
                                    value={newCourseRoom}
                                    onChange={(e) => setNewCourseRoom(e.target.value)}
                                    className="w-full border rounded-lg px-3 py-2 text-sm"
                                    placeholder="例: 3-1教室"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-bold mb-2">色</label>
                                <div className="flex flex-wrap gap-2">
                                    {colorPresets.map(color => (
                                        <button
                                            key={color}
                                            onClick={() => setNewCourseColor(color)}
                                            className={`w-10 h-10 rounded-lg border-2 transition-all ${
                                                newCourseColor === color ? 'border-gray-800 scale-110' : 'border-transparent'
                                            }`}
                                            style={{ backgroundColor: color }}
                                        />
                                    ))}
                                </div>
                            </div>
                            <button
                                onClick={addCourse}
                                className="w-full py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition-colors"
                            >
                                追加
                            </button>
                        </div>
                    </Modal>

                    <Modal
                        isOpen={editingCourse !== null}
                        onClose={() => setEditingCourse(null)}
                        title="講座を編集"
                    >
                        {editingCourse && (
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-bold mb-2">講座名</label>
                                    <input
                                        type="text"
                                        value={editingCourse.name}
                                        onChange={(e) => updateCourse(editingCourse.id, 'name', e.target.value)}
                                        className="w-full border rounded-lg px-3 py-2 text-sm"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold mb-2">教室</label>
                                    <input
                                        type="text"
                                        value={editingCourse.room || ''}
                                        onChange={(e) => updateCourse(editingCourse.id, 'room', e.target.value)}
                                        className="w-full border rounded-lg px-3 py-2 text-sm"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold mb-2">色</label>
                                    <div className="flex flex-wrap gap-2">
                                        {colorPresets.map(color => (
                                            <button
                                                key={color}
                                                onClick={() => updateCourse(editingCourse.id, 'color', color)}
                                                className={`w-10 h-10 rounded-lg border-2 transition-all ${
                                                    editingCourse.color === color ? 'border-gray-800 scale-110' : 'border-transparent'
                                                }`}
                                                style={{ backgroundColor: color }}
                                            />
                                        ))}
                                    </div>
                                </div>
                                <div className="pt-4 border-t">
                                    <button
                                        onClick={() => deleteCourse(editingCourse.id)}
                                        className="w-full py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition-colors flex items-center justify-center gap-2"
                                    >
                                        <Icon name="trash" />
                                        この講座を削除
                                    </button>
                                </div>
                            </div>
                        )}
                    </Modal>
                </div>
            );
        };

        // ============================================================
        // Stats View Component
        // ============================================================

        const StatsView = ({
            weeklySchedules,
            courses,
            basicSchedules,
            weeklyMemos,
            statsRange,
            setStatsRange,
            termSettings,
            setTermSettings,
            periodLabels,
            currentYear
        }) => {
            const [isSettingTerms, setIsSettingTerms] = useState(false);

            const stats = useMemo(() => {
                const counts = {};
                const dates = {};
                courses.forEach(c => {
                    counts[c.id] = 0;
                    dates[c.id] = [];
                });
                let total = 0;

                const rangeStart = statsRange.start;
                const rangeEnd = statsRange.end;

                Object.keys(weeklySchedules).sort().forEach(mondayKey => {
                    const [year, month, day] = mondayKey.split('-').map(Number);
                    const mondayDate = new Date(year, month - 1, day);

                    [0, 1, 2, 3, 4, 5].forEach(dayIndex => {
                        const currentDay = addDays(mondayDate, dayIndex);
                        const dateKey = formatDateKey(currentDay);
                        
                        if (dateKey < rangeStart || dateKey > rangeEnd) return;

                        [1, 2, 3, 4, 5, 6, 7].forEach(period => {
                            const cId = weeklySchedules[mondayKey]?.[`${dayIndex}-${period}`];
                            if (cId && counts[cId] !== undefined) {
                                counts[cId]++;
                                dates[cId].push(formatDateMMDD(currentDay));
                                total++;
                            }
                        });
                    });
                });

                return { counts, dates, total };
            }, [weeklySchedules, courses, statsRange]);

            const copyStats = () => {
                let text = `【${currentYear}年度 授業時数集計】\n期間:${statsRange.start} 〜 ${statsRange.end}\n\n`;
                courses.forEach(c => {
                    if (stats.counts[c.id] > 0) {
                        text += `${c.name}: ${stats.counts[c.id]}コマ (${stats.dates[c.id].join(', ')})\n`;
                    }
                });
                text += `\n合計: ${stats.total}コマ`;
                navigator.clipboard.writeText(text).then(() => alert('コピーしました'));
            };

            const setRange = (type) => {
                const now = new Date();
                const m = getMonday(now);
                if (type === 'week') {
                    setStatsRange({
                        start: formatDateKey(m),
                        end: formatDateKey(addDays(m, 5))
                    });
                } else if (type === 'month') {
                    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    setStatsRange({
                        start: formatDateKey(firstDay),
                        end: formatDateKey(lastDay)
                    });
                } else if (type === 'today') {
                    setStatsRange({ ...statsRange, start: formatDateKey(now) });
                }
            };

            const applyTerm = (term) => {
                if (!term.start || !term.end) {
                    alert('期間を設定してください');
                    setIsSettingTerms(true);
                    return;
                }
                setStatsRange({ start: term.start, end: term.end });
            };

            return (
                <div className="h-full flex flex-col bg-white p-4 overflow-y-auto pb-20">
                    <h2 className="text-lg font-bold mb-4 flex items-center gap-2">
                        <Icon name="chart-pie-slice" />
                        時数集計 ({currentYear}年度)
                    </h2>

                    <div className="mb-4">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-xs font-bold text-gray-500">期間プリセット</span>
                            <button
                                onClick={() => setIsSettingTerms(true)}
                                className="text-indigo-600 text-xs flex items-center gap-1"
                            >
                                <Icon name="gear" />
                                期間設定
                            </button>
                        </div>
                        <div className="flex flex-wrap gap-2">
                            {termSettings.map(term => (
                                <button
                                    key={term.id}
                                    onClick={() => applyTerm(term)}
                                    className={`px-3 py-1.5 rounded-lg text-xs font-bold border transition-colors ${
                                        statsRange.start === term.start && statsRange.end === term.end
                                            ? 'bg-indigo-600 text-white border-indigo-600'
                                            : 'bg-white text-gray-700 border-gray-200 hover:bg-gray-50'
                                    }`}
                                >
                                    {term.name}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="bg-gray-50 p-4 rounded-xl border mb-6">
                        <div className="flex gap-2 mb-4">
                            <button
                                onClick={() => setRange('today')}
                                className="flex-1 py-1 text-xs bg-white border rounded shadow-sm hover:bg-gray-50"
                            >
                                今日
                            </button>
                        </div>
                        <div className="flex items-center gap-2 justify-between mb-2">
                            <input
                                type="date"
                                value={statsRange.start}
                                onChange={e => setStatsRange({ ...statsRange, start: e.target.value })}
                                className="border p-1 rounded text-sm w-[45%]"
                            />
                            <span className="text-gray-400">~</span>
                            <input
                                type="date"
                                value={statsRange.end}
                                onChange={e => setStatsRange({ ...statsRange, end: e.target.value })}
                                className="border p-1 rounded text-sm w-[45%]"
                            />
                        </div>
                    </div>

                    <div className="space-y-4">
                        {courses.filter(c => stats.counts[c.id] > 0).map(c => (
                            <div key={c.id} className="flex items-start gap-3 border-b pb-3 last:border-0">
                                <div
                                    className="w-3 h-10 rounded-full flex-shrink-0 mt-1"
                                    style={{ backgroundColor: c.color }}
                                ></div>
                                <div className="flex-1">
                                    <div className="flex justify-between items-baseline mb-1">
                                        <span className="font-bold text-gray-800">{c.name}</span>
                                        <span className="font-bold text-lg">
                                            {stats.counts[c.id]}
                                            <span className="text-xs font-normal text-gray-500 ml-1">コマ</span>
                                        </span>
                                    </div>
                                    <div className="text-[10px] text-gray-500 leading-tight">
                                        {stats.dates[c.id].join(', ')}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    <button
                        onClick={copyStats}
                        className="mt-8 w-full py-3 bg-gray-800 text-white rounded-lg font-bold flex items-center justify-center gap-2 shadow hover:bg-gray-700"
                    >
                        <Icon name="copy" />
                        結果をコピー
                    </button>

                    <Modal
                        isOpen={isSettingTerms}
                        onClose={() => setIsSettingTerms(false)}
                        title="集計期間の設定"
                    >
                        <div className="space-y-4">
                            <p className="text-xs text-gray-500">よく使う集計期間を設定してください。</p>
                            {termSettings.map((term, index) => (
                                <div key={term.id} className="bg-gray-50 p-3 rounded-lg border">
                                    <div className="flex justify-between items-center mb-2">
                                        <input
                                            type="text"
                                            value={term.name}
                                            onChange={(e) => {
                                                const newTerms = [...termSettings];
                                                newTerms[index].name = e.target.value;
                                                setTermSettings(newTerms);
                                            }}
                                            className="font-bold text-sm bg-transparent border-b border-dashed border-gray-400 w-full mr-2"
                                        />
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <input
                                            type="date"
                                            value={term.start}
                                            onChange={(e) => {
                                                const newTerms = [...termSettings];
                                                newTerms[index].start = e.target.value;
                                                setTermSettings(newTerms);
                                            }}
                                            className="border rounded px-1 py-1 text-xs flex-1"
                                        />
                                        <span className="text-gray-400">~</span>
                                        <input
                                            type="date"
                                            value={term.end}
                                            onChange={(e) => {
                                                const newTerms = [...termSettings];
                                                newTerms[index].end = e.target.value;
                                                setTermSettings(newTerms);
                                            }}
                                            className="border rounded px-1 py-1 text-xs flex-1"
                                        />
                                    </div>
                                </div>
                            ))}
                            <button
                                onClick={() => setIsSettingTerms(false)}
                                className="w-full py-3 bg-indigo-600 text-white rounded-lg font-bold shadow"
                            >
                                設定を完了
                            </button>
                        </div>
                    </Modal>
                </div>
            );
        };

        // ============================================================
        // Render App
        // ============================================================

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
